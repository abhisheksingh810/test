# API Contract: Marking Buddy Integration

This document describes the API endpoints for the Marking Buddy tool integration, enabling third-party applications to interact with submission marking data.

---

## Table of Contents
1. [Authentication](#authentication)
2. [Endpoints](#endpoints)
   - [GET Submission Details](#1-get-submission-details)
   - [POST Save Marking](#2-post-save-marking)
   - [POST Complete Marking](#3-post-complete-marking)

---

## Authentication

**Type:** API Key Authentication

**Header Required:**
```
x-api-key: {api_key}
```

**API Key Format:** `{identifier}_{secret}`

Example: `ak_abc123def456_7890secretkey...`

**Security Notes:**
- API keys are validated using bcrypt hashing with constant-time comparison
- Keys follow the format: `{identifier}_{secret}`
- The identifier is used for lookup, the full key is verified against the stored hash
- API keys can be generated by superadmin users through the system settings

---

## Endpoints

## 1. GET Submission Details

### Endpoint

```
GET /api/submissions/:submissionId/details-with-attempts
```

### Description

Retrieves comprehensive submission details including files, marking assignment, assessment data, grade boundaries, existing marks, and previous submission attempts for a given submission ID.

### Request

### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `submissionId` | string (UUID) | Yes | Unique identifier of the submission |

### Headers

| Header | Type | Required | Description |
|--------|------|----------|-------------|
| `x-api-key` | string | Yes | Valid API key for authentication |

### Example Request

```bash
curl -X GET "https://api.example.com/api/submissions/123e4567-e89b-12d3-a456-426614174000/details-with-attempts" \
  -H "x-api-key: ak_abc123def456_7890secretkey..."
```

## Response

### Success Response (200 OK)

```json
{
  "submission": {
    "id": "string (UUID)",
    "email": "string",
    "firstName": "string",
    "lastName": "string",
    "customAssessmentCode": "string",
    "contextId": "string",
    "status": "string",
    "attemptNumber": "number",
    "submittedAt": "string (ISO 8601)",
    "ltiSessionRecordId": "string (UUID)"
  },
  "files": [
    {
      "id": "string (UUID)",
      "fileName": "string",
      "originalFileName": "string",
      "fileSize": "number",
      "fileType": "string",
      "uploadOrder": "number",
      "uploadedAt": "string (ISO 8601)",
      "turnitinStatus": "string | null",
      "turnitinSimilarityScore": "number | null",
      "turnitinReportUrl": "string | null",
      "presignedUrl": "string | null"
    }
  ],
  "markingAssignment": {
    "markingStatus": "string",
    "holdReason": "string | null",
    "assignedMarkerId": "string (UUID) | null"
  } | null,
  "assignedMarker": {
    "id": "string (UUID)",
    "firstName": "string",
    "lastName": "string",
    "email": "string"
  } | null,
  "assessment": {
    "id": "string (UUID)",
    "code": "string",
    "name": "string",
    "description": "string | null",
    "totalMarks": "number",
    "passMark": "number",
    "maxAttempts": "number",
    "createdAt": "string (ISO 8601)",
    "updatedAt": "string (ISO 8601)"
  } | null,
  "assessmentSections": [
    {
      "id": "string (UUID)",
      "assessmentId": "string (UUID)",
      "sectionNumber": "number",
      "title": "string",
      "description": "string | null",
      "totalMarks": "number",
      "markingOptions": [
        {
          "id": "string (UUID)",
          "sectionId": "string (UUID)",
          "optionNumber": "number",
          "marks": "number",
          "feedback": "string"
        }
      ]
    }
  ],
  "gradeBoundaries": [
    {
      "id": "string (UUID)",
      "assessmentId": "string (UUID)",
      "grade": "string",
      "minPercentage": "number",
      "maxPercentage": "number",
      "order": "number"
    }
  ],
  "existingGrade": {
    "id": "string (UUID)",
    "submissionId": "string (UUID)",
    "marksAchieved": "number",
    "marksAvailable": "number",
    "percentage": "number",
    "grade": "string",
    "overallFeedback": "string | null",
    "skipReasonId": "string (UUID) | null",
    "malpracticeLevelId": "string (UUID) | null",
    "markedBy": "string (UUID)",
    "markedAt": "string (ISO 8601)"
  } | null,
  "existingSectionMarks": [
    {
      "id": "string (UUID)",
      "submissionId": "string (UUID)",
      "sectionId": "string (UUID)",
      "marksAwarded": "number",
      "feedback": "string | null"
    }
  ],
  "previousAttempts": [
    {
      "id": "string (UUID)",
      "attemptNumber": "number",
      "submittedAt": "string (ISO 8601)",
      "status": "string",
      "marksAchieved": "number | null",
      "marksAvailable": "number | null",
      "grade": "string | null"
    }
  ]
}
```

### Response Field Descriptions

#### submission
Core submission information including student details, assessment code, context, status, attempt number, and submission timestamp.

#### files
Array of uploaded files associated with the submission, including TurnItIn plagiarism check status and scores. Each file includes a presignedUrl that provides time-limited (60-minute) access to download the file from Azure Blob Storage.

#### markingAssignment
Marking assignment details including status (waiting, being_marked, on_hold, approval_needed, released), hold reason, and assigned marker ID.

#### assignedMarker
Details of the marker assigned to this submission (if any).

#### assessment
Assessment configuration including code, name, total marks, pass mark, and maximum attempts allowed.

#### assessmentSections
Array of assessment sections with marking options. Each section includes predefined marking options with marks and feedback templates.

#### gradeBoundaries
Grade boundary configuration for the assessment, defining grade thresholds based on percentage ranges.

#### existingGrade
Existing marking data if the submission has been graded, including marks, grade, feedback, skip reason, and malpractice level.

#### existingSectionMarks
Section-level marks and feedback for each assessment section (if submission has been marked).

#### previousAttempts
Historical submission attempts for the same student and assessment, showing attempt number, submission date, status, and grades.

## Error Responses

### 401 Unauthorized - API Key Required
```json
{
  "message": "API key required"
}
```

### 401 Unauthorized - Invalid API Key Format
```json
{
  "message": "Invalid API key format"
}
```

### 401 Unauthorized - Invalid API Key
```json
{
  "message": "Invalid API key"
}
```

### 401 Unauthorized - API Key Inactive
```json
{
  "message": "API key is inactive"
}
```

### 401 Unauthorized - API Key Expired
```json
{
  "message": "API key has expired"
}
```

### 404 Not Found - Submission Not Found
```json
{
  "message": "Submission not found"
}
```

### 500 Internal Server Error
```json
{
  "message": "Internal server error"
}
```

## Status Codes

| Code | Description |
|------|-------------|
| 200 | Success - Returns submission details |
| 401 | Unauthorized - Invalid or missing API key |
| 404 | Not Found - Submission does not exist |
| 500 | Internal Server Error - Server-side error |

## Data Types Reference

### Submission Status Values
- `waiting` - Awaiting marker assignment
- `being_marked` - Currently being marked
- `on_hold` - Marking on hold
- `marking_skipped` - Marking skipped with reason
- `approval_needed` - Pending admin approval
- `released` - Released to student

### TurnItIn Status Values
- `null` - Not submitted to TurnItIn
- `pending` - Submission pending
- `processing` - Being processed
- `complete` - Processing complete
- `error` - Submission failed

## Notes

1. **API Key Security**: 
   - API keys are validated using bcrypt hashing with constant-time comparison
   - Keys follow the format: `{identifier}_{secret}`
   - The identifier is used for lookup, the full key is verified against the stored hash

2. **Null Values**: 
   - Many fields can be `null` if the data is not available or not applicable
   - `assessment`, `markingAssignment`, `assignedMarker`, `existingGrade` can all be `null`

3. **Previous Attempts**: 
   - Includes all historical attempts for the same student and assessment
   - Useful for auto-fill marking and progress tracking
   - Attempts are ordered by attempt number

4. **Assessment Sections**: 
   - Each section includes pre-configured marking options
   - Marking options provide standardized feedback templates
   - Total marks are calculated across all sections

5. **Grade Boundaries**: 
   - Define grade thresholds based on percentage ranges
   - Ordered by the `order` field for proper grade calculation
   - Used to automatically determine final grade from marks achieved

## Usage Examples

### Example 1: Retrieve Submission for Marking
```bash
curl -X GET "https://api.example.com/api/submissions/abc-123/details-with-attempts" \
  -H "x-api-key: ak_test123_secretkey456"
```

### Example 2: Using with Python
```python
import requests

api_key = "ak_test123_secretkey456"
submission_id = "abc-123"
url = f"https://api.example.com/api/submissions/{submission_id}/details-with-attempts"

headers = {
    "x-api-key": api_key
}

response = requests.get(url, headers=headers)

if response.status_code == 200:
    data = response.json()
    print(f"Submission by: {data['submission']['firstName']} {data['submission']['lastName']}")
    print(f"Files: {len(data['files'])}")
    print(f"Previous attempts: {len(data['previousAttempts'])}")
else:
    print(f"Error: {response.status_code} - {response.json()['message']}")
```

### Example 3: Using with JavaScript/Node.js
```javascript
const axios = require('axios');

const apiKey = 'ak_test123_secretkey456';
const submissionId = 'abc-123';
const url = `https://api.example.com/api/submissions/${submissionId}/details-with-attempts`;

axios.get(url, {
  headers: {
    'x-api-key': apiKey
  }
})
.then(response => {
  const { submission, files, previousAttempts } = response.data;
  console.log(`Submission by: ${submission.firstName} ${submission.lastName}`);
  console.log(`Files: ${files.length}`);
  console.log(`Previous attempts: ${previousAttempts.length}`);
})
.catch(error => {
  console.error(`Error: ${error.response.status} - ${error.response.data.message}`);
});
```

---

## 2. POST Save Marking

### Endpoint

```
POST /api/submissions/:submissionId/external-marking
```

### Description

Saves in-progress marking data for a submission without completing the marking process. This endpoint allows marking buddy tools to save section marks, feedback, and overall summary as the marker works through the submission.

### Request

#### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `submissionId` | string (UUID) | Yes | Unique identifier of the submission |

#### Headers

| Header | Type | Required | Description |
|--------|------|----------|-------------|
| `x-api-key` | string | Yes | Valid API key for authentication |

#### Request Body

```json
{
  "sectionMarks": {
    "section-id-1": {
      "marksAwarded": 15,
      "feedback": "Good analysis of the topic",
      "selectedOptionId": "option-id-1",
      "markingCriterion": {
        "criterionName": "Analysis Quality",
        "score": 4,
        "maxScore": 5,
        "comments": "Strong analytical skills demonstrated"
      }
    },
    "section-id-2": {
      "marksAwarded": 20,
      "feedback": "Excellent research and citations",
      "selectedOptionId": "option-id-2",
      "markingCriterion": {
        "criterionName": "Research Quality",
        "score": 5,
        "maxScore": 5,
        "comments": "Outstanding research methodology"
      }
    }
  },
  "overallGrade": {
    "overallSummary": "Work in progress feedback",
    "skipReasonId": null,
    "skippedReason": "",
    "malpracticeLevelId": null,
    "malpracticeNotes": "",
    "wordCount": 2500
  },
  "onHold": false,
  "holdReason": null
}
```

#### Request Body Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `sectionMarks` | object | Yes | Object mapping section IDs to marking data |
| `sectionMarks[sectionId].marksAwarded` | number | No | Marks awarded for this section |
| `sectionMarks[sectionId].feedback` | string | No | Feedback text for this section |
| `sectionMarks[sectionId].selectedOptionId` | string | No | ID of the selected marking option |
| `sectionMarks[sectionId].markingCriterion` | object | No | Custom marking criteria data (stored as JSON) |
| `overallGrade.overallSummary` | string | No | Overall feedback summary |
| `overallGrade.skipReasonId` | string | No | ID of skip reason if applicable |
| `overallGrade.skippedReason` | string | No | Custom skip reason text (legacy field) |
| `overallGrade.malpracticeLevelId` | string | No | ID of malpractice level if applicable |
| `overallGrade.malpracticeNotes` | string | No | Malpractice notes (legacy field) |
| `overallGrade.wordCount` | number | No | Word count of the submission |
| `onHold` | boolean | No | Whether to put marking on hold |
| `holdReason` | string | No | Reason for putting on hold (if onHold is true) |

### Response

#### Success Response (200 OK)

```json
{
  "message": "Marking saved successfully"
}
```

### Error Responses

See [Common Error Responses](#common-error-responses) section below.

### Behavior Notes

1. **Partial Validation**: Section marks are only validated if provided (more lenient than complete marking)
2. **Status Updates**:
   - Default status: `being_marked`
   - If `onHold` is true: status changes to `on_hold`
   - If `skipReasonId` is provided: status changes to `marking_skipped`
3. **Marking Criterion**: The `markingCriterion` field accepts any valid JSON object and is stored in the `marking_criterias` JSONB column
4. **No User Attribution**: API key authenticated requests do not link to a specific user ID (markerId is null)

---

## 3. POST Complete Marking

### Endpoint

```
POST /api/submissions/:submissionId/external-complete-marking
```

### Description

Completes the marking process for a submission, calculating final grades, updating submission status, and handling malpractice enforcement if applicable.

### Request

#### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `submissionId` | string (UUID) | Yes | Unique identifier of the submission |

#### Headers

| Header | Type | Required | Description |
|--------|------|----------|-------------|
| `x-api-key` | string | Yes | Valid API key for authentication |

#### Request Body

```json
{
  "sectionMarks": {
    "section-id-1": {
      "marksAwarded": 15,
      "feedback": "Good analysis of the topic",
      "selectedOptionId": "option-id-1",
      "markingCriterion": {
        "criterionName": "Analysis Quality",
        "score": 4,
        "maxScore": 5,
        "comments": "Strong analytical skills demonstrated"
      }
    },
    "section-id-2": {
      "marksAwarded": 20,
      "feedback": "Excellent research and citations",
      "selectedOptionId": "option-id-2",
      "markingCriterion": {
        "criterionName": "Research Quality",
        "score": 5,
        "maxScore": 5,
        "comments": "Outstanding research methodology"
      }
    }
  },
  "overallGrade": {
    "overallSummary": "Excellent work overall. Strong analytical skills and comprehensive research.",
    "skipReasonId": null,
    "skippedReason": "",
    "malpracticeLevelId": null,
    "malpracticeNotes": "",
    "wordCount": 2500
  }
}
```

#### Request Body Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `sectionMarks` | object | Yes | Object mapping section IDs to marking data |
| `sectionMarks[sectionId].marksAwarded` | number | Conditional* | Marks awarded for this section |
| `sectionMarks[sectionId].feedback` | string | No | Feedback text for this section |
| `sectionMarks[sectionId].selectedOptionId` | string | No | ID of the selected marking option |
| `sectionMarks[sectionId].markingCriterion` | object | No | Custom marking criteria data (stored as JSON) |
| `overallGrade.overallSummary` | string | Yes | Overall feedback summary (always required) |
| `overallGrade.skipReasonId` | string | No | ID of skip reason if applicable |
| `overallGrade.skippedReason` | string | No | Custom skip reason text (legacy field) |
| `overallGrade.malpracticeLevelId` | string | No | ID of malpractice level if applicable |
| `overallGrade.malpracticeNotes` | string | No | Malpractice notes (legacy field) |
| `overallGrade.wordCount` | number | No | Word count of the submission |

*Required unless `skipReasonId` or `malpracticeLevelId` is provided

### Response

#### Success Response (200 OK)

```json
{
  "message": "Marking completed successfully",
  "finalGrade": "Merit",
  "totalMarksAwarded": 35,
  "totalMarksPossible": 40
}
```

#### Response Fields

| Field | Type | Description |
|-------|------|-------------|
| `message` | string | Success confirmation message |
| `finalGrade` | string | Final grade label based on grade boundaries |
| `totalMarksAwarded` | number | Total marks achieved across all sections |
| `totalMarksPossible` | number | Maximum marks available |

### Error Responses

See [Common Error Responses](#common-error-responses) section below.

#### Additional Validation Errors

**Missing Overall Summary**
```json
{
  "message": "Overall feedback is required for this submission"
}
```

**Missing Section Marks**
```json
{
  "message": "Valid marks are required for question: \"Section Title\""
}
```

**Invalid Marks Range**
```json
{
  "message": "Marks must not exceed 20 for question: \"Section Title\""
}
```

### Behavior Notes

1. **Validation Requirements**:
   - `overallSummary` is always required
   - Section marks and feedback are required UNLESS `skipReasonId` or `malpracticeLevelId` is provided
   - Marks must be within the valid range defined by marking options

2. **Grade Calculation**:
   - Total marks are calculated by summing all section marks
   - Final grade is determined by matching total marks against grade boundaries
   - If `malpracticeLevelId` is provided, grade is overridden with the first failing grade

3. **Status Updates**:
   - If `skipReasonId` is provided: status = `marking_skipped`
   - Otherwise: status = `approval_needed`

4. **Malpractice Enforcement**:
   - **Moderate**: No attempt restriction (normal 3-attempt limit)
   - **Considerable**: Maximum attempts = current attempt + 1
   - **Severe**: Maximum attempts = current attempt (blocks future submissions)
   - Enforcement records are created or updated to restrict future submissions

5. **Marking Criterion**: The `markingCriterion` field accepts any valid JSON object and is stored in the `marking_criterias` JSONB column for later retrieval and analysis

---

## Common Error Responses

### 401 Unauthorized - API Key Required
```json
{
  "message": "API key required"
}
```

### 401 Unauthorized - Invalid API Key Format
```json
{
  "message": "Invalid API key format"
}
```

### 401 Unauthorized - Invalid API Key
```json
{
  "message": "Invalid API key"
}
```

### 401 Unauthorized - API Key Inactive
```json
{
  "message": "API key is inactive"
}
```

### 401 Unauthorized - API Key Expired
```json
{
  "message": "API key has expired"
}
```

### 404 Not Found - Submission Not Found
```json
{
  "message": "Submission not found"
}
```

### 500 Internal Server Error
```json
{
  "message": "Internal server error"
}
```

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2025-10-14 | Initial release with API key authentication |
| 1.1 | 2025-10-14 | Added POST endpoints for saving and completing marking |

## Support

For API key generation and management, contact your system administrator with superadmin privileges.
