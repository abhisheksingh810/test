import { sql } from "drizzle-orm";
import { pgTable, text, varchar, timestamp, pgEnum, integer, boolean } from "drizzle-orm/pg-core";
import { relations } from "drizzle-orm";
import { createInsertSchema } from "drizzle-zod";
import { z } from "zod";

// Define user roles enum
export const userRoleEnum = pgEnum("user_role", [
  "superadmin",
  "admin", 
  "marker",
  "tutor",
  "iqa",
  "student"
]);

// Define user status enum
export const userStatusEnum = pgEnum("user_status", [
  "active",
  "inactive", 
  "pending"
]);

// Define instruction step type enum
export const instructionStepTypeEnum = pgEnum("instruction_step_type", [
  "info",
  "checkbox", 
  "upload"
]);

// Define course status enum
export const courseStatusEnum = pgEnum("course_status", [
  "active",
  "inactive",
  "archived"
]);

// Define assessment status enum
export const assessmentStatusEnum = pgEnum("assessment_status", [
  "active",
  "inactive",
  "draft",
  "archived"
]);

// Define assessment type enum
export const assessmentTypeEnum = pgEnum("assessment_type", [
  "formative",
  "summative",
  "diagnostic",
  "competency"
]);

// Users table
export const users = pgTable("users", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  username: text("username").notNull().unique(),
  email: text("email").notNull().unique(),
  password: text("password").notNull(),
  firstName: text("first_name"),
  lastName: text("last_name"),
  role: userRoleEnum("role").notNull().default("student"),
  status: userStatusEnum("status").notNull().default("active"),
  department: text("department"),
  profileImageUrl: text("profile_image_url"),
  lastLoginAt: timestamp("last_login_at", { withTimezone: true }),
  createdAt: timestamp("created_at", { withTimezone: true }).defaultNow(),
  updatedAt: timestamp("updated_at", { withTimezone: true }).defaultNow()
});

// System settings table
export const systemSettings = pgTable("system_settings", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  key: text("key").notNull().unique(),
  value: text("value"),
  description: text("description"),
  updatedAt: timestamp("updated_at", { withTimezone: true }).defaultNow(),
  updatedBy: varchar("updated_by").references(() => users.id)
});

// Email templates table for storing HubSpot email template configurations
export const emailTemplates = pgTable("email_templates", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  templateKey: text("template_key").notNull().unique(), // e.g., 'invite_user', 'forgot_password'
  hubspotEmailId: text("hubspot_email_id"), // HubSpot email template ID (optional if using custom HTML)
  templateName: text("template_name").notNull(),
  description: text("description"),
  subject: text("subject"), // Email subject line
  htmlContent: text("html_content"), // Custom HTML template content
  textContent: text("text_content"), // Plain text fallback content
  isActive: text("is_active").notNull().default("true"),
  createdAt: timestamp("created_at", { withTimezone: true }).defaultNow(),
  updatedAt: timestamp("updated_at", { withTimezone: true }).defaultNow()
});

// User sessions table
export const userSessions = pgTable("user_sessions", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  userId: varchar("user_id").notNull().references(() => users.id),
  sessionToken: text("session_token").notNull().unique(),
  expiresAt: timestamp("expires_at", { withTimezone: true }).notNull(),
  createdAt: timestamp("created_at", { withTimezone: true }).defaultNow()
});

// Password reset tokens table
export const passwordResetTokens = pgTable("password_reset_tokens", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  userId: varchar("user_id").notNull().references(() => users.id),
  token: text("token").notNull().unique(),
  expiresAt: timestamp("expires_at", { withTimezone: true }).notNull(),
  used: text("used").notNull().default("false"),
  createdAt: timestamp("created_at", { withTimezone: true }).defaultNow()
});



// LTI Session Records - captures all LTI data during initial launch
export const ltiSessionRecords = pgTable("lti_session_records", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  launchId: text("launch_id").notNull().unique(),
  // Core LTI fields extracted during launch
  lmsUserId: text("lms_user_id"), // From user_id
  consumerName: text("consumer_name"), // From tool_consumer_instance_name
  role: text("role"), // From roles
  firstName: text("first_name"), // From lis_person_name_given
  lastName: text("last_name"), // From lis_person_name_family
  fullName: text("full_name"), // From lis_person_name_full
  email: text("email"), // From lis_person_contact_email_primary
  customAction: text("custom_action"), // From custom_action
  // LTI parameter fields
  customInstructionSet: text("custom_instruction_set"), // From cis parameter
  customAssessmentCode: text("custom_assessment_code"), // From cas parameter
  contextType: text("context_type"), // From context_type
  contextTitle: text("context_title"), // From context_title
  // Additional LTI context
  resourceLinkId: text("resource_link_id"),
  resourceLinkTitle: text("resource_link_title"),
  contextId: text("context_id"),
  consumerKey: text("consumer_key"),
  toolConsumerInstanceGuid: text("tool_consumer_instance_guid"),
  returnUrl: text("return_url"),
  // Session status tracking
  hasFileSubmission: text("has_file_submission").default("false"),
  sessionExpiry: timestamp("session_expiry", { withTimezone: true }).notNull(),
  createdAt: timestamp("created_at", { withTimezone: true }).defaultNow()
});

// Assignment submissions table - simplified for LTI-only usage
export const assignmentSubmissions = pgTable("assignment_submissions", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  // Link to LTI session record
  ltiSessionRecordId: varchar("lti_session_record_id").references(() => ltiSessionRecords.id),
  ltiLaunchId: varchar("lti_launch_id").notNull(), // Keep for legacy compatibility
  // Multiple files support
  fileCount: integer("file_count").notNull().default(0),
  totalFileSize: text("total_file_size"), // Combined size of all files
  submittedAt: timestamp("submitted_at", { withTimezone: true }).defaultNow(),
  // Store comprehensive LTI student and context info directly from LTI parameters
  lmsUserId: text("lms_user_id"), // From user_id (copied from session record)
  consumerName: text("consumer_name"), // From tool_consumer_instance_name
  role: text("role"), // From roles
  firstName: text("first_name"), // From lis_person_name_given
  lastName: text("last_name"), // From lis_person_name_family
  fullName: text("full_name"), // From lis_person_name_full
  email: text("email"), // From lis_person_contact_email_primary
  // LTI parameter fields for assignment submissions
  customInstructionSet: text("custom_instruction_set"), // From cis parameter
  customAssessmentCode: text("custom_assessment_code"), // From cas parameter
  customAction: text("custom_action"), // From custom_action
  contextType: text("context_type"), // From context_type
  contextTitle: text("context_title"), // From context_title
  // Legacy fields for backward compatibility - single file fields
  fileName: text("file_name"), // Deprecated - use submissionFiles table
  fileSize: text("file_size"), // Deprecated - use submissionFiles table
  fileType: text("file_type"), // Deprecated - use submissionFiles table
  fileUrl: text("file_url"), // Deprecated - use submissionFiles table
  azureBlobUrl: text("azure_blob_url"), // Deprecated - use submissionFiles table
  azureContainerName: text("azure_container_name").default("rogoreplacement"), // Deprecated
  azureBlobName: text("azure_blob_name"), // Deprecated - use submissionFiles table
  studentUserId: text("student_user_id"), // Deprecated - use lmsUserId
  studentEmail: text("student_email"), // Deprecated - use email
  studentName: text("student_name"), // Deprecated - use fullName
  courseName: text("course_name"), // Deprecated - use contextTitle
});

// Individual submission files table - supports multiple files per submission
export const submissionFiles = pgTable("submission_files", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  submissionId: varchar("submission_id").references(() => assignmentSubmissions.id, { onDelete: 'cascade' }),
  fileName: text("file_name").notNull(),
  originalFileName: text("original_file_name").notNull(), // Original name before processing
  fileSize: text("file_size"),
  fileType: text("file_type"),
  fileMimeType: text("file_mime_type"),
  fileUrl: text("file_url").notNull(), // Azure Blob Storage URL
  azureBlobUrl: text("azure_blob_url"), // Full Azure Blob Storage URL
  azureContainerName: text("azure_container_name").default("rogoreplacement"),
  azureBlobName: text("azure_blob_name"), // Blob name in Azure Storage
  uploadOrder: integer("upload_order").notNull().default(1), // Order of file in submission
  uploadedAt: timestamp("uploaded_at", { withTimezone: true }).defaultNow(),
});

// LTI launch sessions table
export const ltiLaunchSessions = pgTable("lti_launch_sessions", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  launchId: text("launch_id").notNull().unique(),
  consumerKey: text("consumer_key").notNull(),
  userId: text("user_id"),
  userEmail: text("user_email"),
  userName: text("user_name"),
  courseName: text("course_name"),
  returnUrl: text("return_url"),
  resourceLinkId: text("resource_link_id"),
  contextId: text("context_id"),
  toolConsumerInstanceGuid: text("tool_consumer_instance_guid"),
  customParams: text("custom_params"),
  // All LTI fields from parameters
  ltiMessageType: text("lti_message_type"),
  contextType: text("context_type"),
  contextTitle: text("context_title"),
  roles: text("roles"),
  lisPersonNameGiven: text("lis_person_name_given"),
  lisPersonNameFamily: text("lis_person_name_family"),
  lisPersonNameFull: text("lis_person_name_full"),
  lisPersonContactEmailPrimary: text("lis_person_contact_email_primary"),
  toolConsumerInstanceName: text("tool_consumer_instance_name"),
  // Additional custom parameters
  customAction: text("custom_action"),
  // LTI parameter fields
  customInstructionSet: text("custom_instruction_set"), // From cis parameter
  customAssessmentCode: text("custom_assessment_code"), // From cas parameter
  createdAt: timestamp("created_at", { withTimezone: true }).defaultNow(),
  expiresAt: timestamp("expires_at", { withTimezone: true }).notNull()
});

// Instruction sets table for grouping instruction flows
export const instructionSets = pgTable("instruction_sets", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  name: text("name").notNull(),
  description: text("description"),
  slug: text("slug").notNull().unique(), // URL-friendly identifier
  instructionSetCode: text("instruction_set_code").unique(), // Instruction set code for LTI mapping (e.g., TEST, something)
  completionMessage: text("completion_message"), // HTML message shown after file submission
  submissionTitle: text("submission_title"), // Customizable title for completion screen
  isActive: text("is_active").notNull().default("true"),
  createdAt: timestamp("created_at", { withTimezone: true }).defaultNow(),
  updatedAt: timestamp("updated_at", { withTimezone: true }).defaultNow()
});

// Instruction steps table for configurable LTI flow
export const instructionSteps = pgTable("instruction_steps", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  instructionSetId: varchar("instruction_set_id").references(() => instructionSets.id, { onDelete: 'cascade' }),
  stepNumber: text("step_number").notNull(), // e.g., "1", "2", "3"
  title: text("title").notNull(),
  content: text("content").notNull(),
  stepType: instructionStepTypeEnum("step_type").notNull().default("info"),
  checkboxItems: text("checkbox_items").array(), // For checkbox type steps
  isActive: text("is_active").notNull().default("true"),
  createdAt: timestamp("created_at", { withTimezone: true }).defaultNow(),
  updatedAt: timestamp("updated_at", { withTimezone: true }).defaultNow()
});

// Course categories table - topmost level grouping
export const courseCategories = pgTable("course_categories", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  name: text("name").notNull().unique(), // e.g., "CIPD HR Courses", "CIPD L&D Courses"
  description: text("description"),
  isActive: text("is_active").notNull().default("true"),
  createdAt: timestamp("created_at", { withTimezone: true }).defaultNow(),
  updatedAt: timestamp("updated_at", { withTimezone: true }).defaultNow()
});

// Courses table - abstraction for a set of assessments
export const courses = pgTable("courses", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  categoryId: varchar("category_id").references(() => courseCategories.id, { onDelete: 'cascade' }),
  name: text("name").notNull(), // e.g., "L3 CIPD Foundation Certificate in People Practice"
  code: text("code").notNull().unique(), // e.g., "L3FCPP", "L5ADPM"
  description: text("description"),
  status: courseStatusEnum("status").notNull().default("active"),
  isActive: text("is_active").notNull().default("true"),
  createdAt: timestamp("created_at", { withTimezone: true }).defaultNow(),
  updatedAt: timestamp("updated_at", { withTimezone: true }).defaultNow()
});

// Assessments table - individual assessments within courses
export const assessments = pgTable("assessments", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  courseId: varchar("course_id").references(() => courses.id, { onDelete: 'cascade' }),
  instructionSetId: varchar("instruction_set_id").references(() => instructionSets.id),
  assessmentId: text("assessment_id").notNull().unique().default(sql`'ASS_' || substr(gen_random_uuid()::text, 1, 8)`), // Auto-generated internal ID
  code: text("code").notNull().unique(), // e.g., "3CO02_25_PQA1"
  name: text("name").notNull(),
  description: text("description"),
  type: assessmentTypeEnum("type").notNull().default("summative"),
  status: assessmentStatusEnum("status").notNull().default("active"),
  eligibilityPrerequisites: text("eligibility_prerequisites").array(), // Array of assessment IDs that must be completed first
  totalMarks: integer("total_marks").notNull().default(0),
  isActive: text("is_active").notNull().default("true"),
  createdAt: timestamp("created_at", { withTimezone: true }).defaultNow(),
  updatedAt: timestamp("updated_at", { withTimezone: true }).defaultNow()
});

// Assessment sections table - sections within an assessment for marking
export const assessmentSections = pgTable("assessment_sections", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  assessmentId: varchar("assessment_id").references(() => assessments.id, { onDelete: 'cascade' }),
  name: text("name").notNull(),
  questionText: text("question_text"), // The actual question/instruction text for this section
  questions: integer("questions").notNull().default(1),
  order: integer("order").notNull(),
  isActive: text("is_active").notNull().default("true"),
  createdAt: timestamp("created_at", { withTimezone: true }).defaultNow(),
  updatedAt: timestamp("updated_at", { withTimezone: true }).defaultNow()
});

// Marking options for each section
export const sectionMarkingOptions = pgTable("section_marking_options", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  sectionId: varchar("section_id").references(() => assessmentSections.id, { onDelete: 'cascade' }),
  label: text("label").notNull(),
  marks: integer("marks").notNull(),
  order: integer("order").notNull(),
  isActive: text("is_active").notNull().default("true"),
  createdAt: timestamp("created_at", { withTimezone: true }).defaultNow(),
  updatedAt: timestamp("updated_at", { withTimezone: true }).defaultNow()
});

// Grade boundaries for assessments
export const assessmentGradeBoundaries = pgTable("assessment_grade_boundaries", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  assessmentId: varchar("assessment_id").references(() => assessments.id, { onDelete: 'cascade' }),
  gradeLabel: text("grade_label").notNull(),
  percentageFrom: integer("percentage_from").notNull(),
  percentageTo: integer("percentage_to").notNull(),
  isPass: boolean("is_pass").notNull().default(false),
  order: integer("order").notNull(),
  isActive: text("is_active").notNull().default("true"),
  createdAt: timestamp("created_at", { withTimezone: true }).defaultNow(),
  updatedAt: timestamp("updated_at", { withTimezone: true }).defaultNow()
});

// Define relations
export const usersRelations = relations(users, ({ many }) => ({
  sessions: many(userSessions),
  settingsUpdates: many(systemSettings)
}));

export const userSessionsRelations = relations(userSessions, ({ one }) => ({
  user: one(users, {
    fields: [userSessions.userId],
    references: [users.id]
  })
}));

export const systemSettingsRelations = relations(systemSettings, ({ one }) => ({
  updatedByUser: one(users, {
    fields: [systemSettings.updatedBy],
    references: [users.id]
  })
}));



export const ltiSessionRecordsRelations = relations(ltiSessionRecords, ({ many }) => ({
  submissions: many(assignmentSubmissions)
}));

export const assignmentSubmissionsRelations = relations(assignmentSubmissions, ({ one, many }) => ({
  ltiLaunch: one(ltiLaunchSessions, {
    fields: [assignmentSubmissions.ltiLaunchId],
    references: [ltiLaunchSessions.launchId]
  }),
  ltiSessionRecord: one(ltiSessionRecords, {
    fields: [assignmentSubmissions.ltiSessionRecordId],
    references: [ltiSessionRecords.id]
  }),
  files: many(submissionFiles)
}));

export const submissionFilesRelations = relations(submissionFiles, ({ one }) => ({
  submission: one(assignmentSubmissions, {
    fields: [submissionFiles.submissionId],
    references: [assignmentSubmissions.id]
  })
}));

export const ltiLaunchSessionsRelations = relations(ltiLaunchSessions, ({ many }) => ({
  submissions: many(assignmentSubmissions)
}));

export const instructionSetsRelations = relations(instructionSets, ({ many }) => ({
  steps: many(instructionSteps)
}));

export const instructionStepsRelations = relations(instructionSteps, ({ one }) => ({
  instructionSet: one(instructionSets, {
    fields: [instructionSteps.instructionSetId],
    references: [instructionSets.id]
  })
}));

export const courseCategoriesRelations = relations(courseCategories, ({ many }) => ({
  courses: many(courses)
}));

export const coursesRelations = relations(courses, ({ one, many }) => ({
  category: one(courseCategories, {
    fields: [courses.categoryId],
    references: [courseCategories.id]
  }),
  assessments: many(assessments)
}));

export const assessmentsRelations = relations(assessments, ({ one, many }) => ({
  course: one(courses, {
    fields: [assessments.courseId],
    references: [courses.id]
  }),
  instructionSet: one(instructionSets, {
    fields: [assessments.instructionSetId],
    references: [instructionSets.id]
  }),
  sections: many(assessmentSections),
  gradeBoundaries: many(assessmentGradeBoundaries)
}));

export const assessmentSectionsRelations = relations(assessmentSections, ({ one, many }) => ({
  assessment: one(assessments, {
    fields: [assessmentSections.assessmentId],
    references: [assessments.id]
  }),
  markingOptions: many(sectionMarkingOptions)
}));

export const sectionMarkingOptionsRelations = relations(sectionMarkingOptions, ({ one }) => ({
  section: one(assessmentSections, {
    fields: [sectionMarkingOptions.sectionId],
    references: [assessmentSections.id]
  })
}));

export const assessmentGradeBoundariesRelations = relations(assessmentGradeBoundaries, ({ one }) => ({
  assessment: one(assessments, {
    fields: [assessmentGradeBoundaries.assessmentId],
    references: [assessments.id]
  })
}));

export const emailTemplatesRelations = relations(emailTemplates, ({ }) => ({}));

// Insert schemas
export const insertUserSchema = createInsertSchema(users).pick({
  username: true,
  email: true,
  password: true,
  firstName: true,
  lastName: true,
  role: true,
  status: true,
  department: true,
  profileImageUrl: true
});

// Simplified schema for creating new users (only email and role required)
export const createUserSchema = createInsertSchema(users).pick({
  email: true,
  role: true,
});

// Profile update schema - allows editing name and password, email is locked
export const updateProfileSchema = createInsertSchema(users).pick({
  firstName: true,
  lastName: true,
  password: true,
}).partial();

// Admin user edit schema - allows admins to edit user info (excludes email, username, password)
export const adminEditUserSchema = createInsertSchema(users).pick({
  firstName: true,
  lastName: true,
  role: true,
  status: true,
}).partial();

// Password change schema with current password verification
export const changePasswordSchema = z.object({
  currentPassword: z.string().min(1, "Current password is required"),
  newPassword: z.string().min(8, "Password must be at least 8 characters"),
  confirmPassword: z.string().min(1, "Password confirmation is required")
}).refine((data) => data.newPassword === data.confirmPassword, {
  message: "Passwords don't match",
  path: ["confirmPassword"],
});

// Forgot password request schema
export const forgotPasswordSchema = z.object({
  email: z.string().email("Please enter a valid email address")
});

// Reset password schema
export const resetPasswordSchema = z.object({
  token: z.string().min(1, "Reset token is required"),
  newPassword: z.string().min(8, "Password must be at least 8 characters"),
  confirmPassword: z.string().min(1, "Password confirmation is required")
}).refine((data) => data.newPassword === data.confirmPassword, {
  message: "Passwords don't match",
  path: ["confirmPassword"],
});

export const insertSystemSettingSchema = createInsertSchema(systemSettings).pick({
  key: true,
  value: true,
  description: true
});

export const insertUserSessionSchema = createInsertSchema(userSessions).pick({
  userId: true,
  sessionToken: true,
  expiresAt: true
});

export const insertPasswordResetTokenSchema = createInsertSchema(passwordResetTokens).pick({
  userId: true,
  token: true,
  expiresAt: true,
  used: true
});



export const insertLtiSessionRecordSchema = createInsertSchema(ltiSessionRecords).pick({
  launchId: true,
  lmsUserId: true,
  consumerName: true,
  role: true,
  firstName: true,
  lastName: true,
  fullName: true,
  email: true,
  customAction: true,
  customInstructionSet: true,
  customAssessmentCode: true,
  contextType: true,
  contextTitle: true,
  resourceLinkId: true,
  resourceLinkTitle: true,
  contextId: true,
  consumerKey: true,
  toolConsumerInstanceGuid: true,
  returnUrl: true,
  hasFileSubmission: true,
  sessionExpiry: true
});

export const insertAssignmentSubmissionSchema = createInsertSchema(assignmentSubmissions).pick({
  ltiSessionRecordId: true,
  ltiLaunchId: true,
  fileCount: true,
  totalFileSize: true,
  // LTI fields
  lmsUserId: true,
  consumerName: true,
  role: true,
  firstName: true,
  lastName: true,
  fullName: true,
  email: true,
  customAction: true,
  customInstructionSet: true,
  customAssessmentCode: true,
  contextType: true,
  contextTitle: true,
  // Legacy fields for backward compatibility
  fileName: true,
  fileSize: true,
  fileType: true,
  fileUrl: true,
  azureBlobUrl: true,
  azureContainerName: true,
  azureBlobName: true,
  studentUserId: true,
  studentEmail: true,
  studentName: true,
  courseName: true
});

export const insertSubmissionFileSchema = createInsertSchema(submissionFiles).pick({
  submissionId: true,
  fileName: true,
  originalFileName: true,
  fileSize: true,
  fileType: true,
  fileMimeType: true,
  fileUrl: true,
  azureBlobUrl: true,
  azureContainerName: true,
  azureBlobName: true,
  uploadOrder: true
});

export const insertLtiLaunchSessionSchema = createInsertSchema(ltiLaunchSessions).pick({
  launchId: true,
  consumerKey: true,
  userId: true,
  userEmail: true,
  userName: true,
  courseName: true,
  returnUrl: true,
  resourceLinkId: true,
  contextId: true,
  toolConsumerInstanceGuid: true,
  customParams: true,
  ltiMessageType: true,
  contextType: true,
  contextTitle: true,
  roles: true,
  lisPersonNameGiven: true,
  lisPersonNameFamily: true,
  lisPersonNameFull: true,
  lisPersonContactEmailPrimary: true,
  toolConsumerInstanceName: true,
  customAction: true,
  customInstructionSet: true,
  customAssessmentCode: true,
  expiresAt: true
});

export const insertInstructionSetSchema = createInsertSchema(instructionSets).pick({
  name: true,
  description: true,
  slug: true,
  completionMessage: true,
  isActive: true
});

export const insertInstructionStepSchema = createInsertSchema(instructionSteps).pick({
  instructionSetId: true,
  stepNumber: true,
  title: true,
  content: true,
  stepType: true,
  checkboxItems: true,
  isActive: true
});

export const insertEmailTemplateSchema = createInsertSchema(emailTemplates).pick({
  templateKey: true,
  hubspotEmailId: true,
  templateName: true,
  description: true,
  subject: true,
  htmlContent: true,
  isActive: true
});

export const insertCourseCategorySchema = createInsertSchema(courseCategories).pick({
  name: true,
  description: true,
  isActive: true
});

export const insertCourseSchema = createInsertSchema(courses).pick({
  categoryId: true,
  name: true,
  code: true,
  description: true,
  status: true,
  isActive: true
});

export const insertAssessmentSchema = createInsertSchema(assessments).pick({
  courseId: true,
  instructionSetId: true,
  code: true,
  name: true,
  description: true,
  status: true,
  eligibilityPrerequisites: true,
  isActive: true
});

export const insertAssessmentSectionSchema = createInsertSchema(assessmentSections).pick({
  assessmentId: true,
  name: true,
  questionText: true,
  questions: true,
  order: true,
  isActive: true
});

export const insertSectionMarkingOptionSchema = createInsertSchema(sectionMarkingOptions).pick({
  sectionId: true,
  label: true,
  marks: true,
  order: true,
  isActive: true
});

export const insertAssessmentGradeBoundarySchema = createInsertSchema(assessmentGradeBoundaries).pick({
  assessmentId: true,
  gradeLabel: true,
  percentageFrom: true,
  percentageTo: true,
  isPass: true,
  order: true,
  isActive: true
});

// Types
export type InsertUser = z.infer<typeof insertUserSchema>;
export type CreateUser = z.infer<typeof createUserSchema>;
export type UpdateProfile = z.infer<typeof updateProfileSchema>;
export type AdminEditUser = z.infer<typeof adminEditUserSchema>;
export type ChangePassword = z.infer<typeof changePasswordSchema>;
export type User = typeof users.$inferSelect;
export type UserRole = typeof users.$inferSelect.role;
export type UserStatus = typeof users.$inferSelect.status;
export type InsertSystemSetting = z.infer<typeof insertSystemSettingSchema>;
export type SystemSetting = typeof systemSettings.$inferSelect;
export type InsertUserSession = z.infer<typeof insertUserSessionSchema>;
export type UserSession = typeof userSessions.$inferSelect;
export type InsertPasswordResetToken = z.infer<typeof insertPasswordResetTokenSchema>;
export type PasswordResetToken = typeof passwordResetTokens.$inferSelect;
export type ForgotPassword = z.infer<typeof forgotPasswordSchema>;
export type ResetPassword = z.infer<typeof resetPasswordSchema>;

export type InsertLtiSessionRecord = z.infer<typeof insertLtiSessionRecordSchema>;
export type LtiSessionRecord = typeof ltiSessionRecords.$inferSelect;
export type InsertAssignmentSubmission = z.infer<typeof insertAssignmentSubmissionSchema>;
export type AssignmentSubmission = typeof assignmentSubmissions.$inferSelect;
export type InsertSubmissionFile = z.infer<typeof insertSubmissionFileSchema>;
export type SubmissionFile = typeof submissionFiles.$inferSelect;
export type InsertLtiLaunchSession = z.infer<typeof insertLtiLaunchSessionSchema>;
export type LtiLaunchSession = typeof ltiLaunchSessions.$inferSelect;
export type InsertInstructionSet = z.infer<typeof insertInstructionSetSchema>;
export type InstructionSet = typeof instructionSets.$inferSelect;
export type InsertInstructionStep = z.infer<typeof insertInstructionStepSchema>;
export type InstructionStep = typeof instructionSteps.$inferSelect;
export type InstructionStepType = typeof instructionSteps.$inferSelect.stepType;
export type InsertEmailTemplate = z.infer<typeof insertEmailTemplateSchema>;
export type EmailTemplate = typeof emailTemplates.$inferSelect;
export type InsertCourseCategory = z.infer<typeof insertCourseCategorySchema>;
export type CourseCategory = typeof courseCategories.$inferSelect;
export type InsertCourse = z.infer<typeof insertCourseSchema>;
export type Course = typeof courses.$inferSelect;
export type CourseStatus = typeof courses.$inferSelect.status;
export type InsertAssessment = z.infer<typeof insertAssessmentSchema>;
export type Assessment = typeof assessments.$inferSelect;
export type AssessmentStatus = typeof assessments.$inferSelect.status;
export type AssessmentType = typeof assessments.$inferSelect.type;
export type InsertAssessmentSection = z.infer<typeof insertAssessmentSectionSchema>;
export type AssessmentSection = typeof assessmentSections.$inferSelect;
export type InsertSectionMarkingOption = z.infer<typeof insertSectionMarkingOptionSchema>;
export type SectionMarkingOption = typeof sectionMarkingOptions.$inferSelect;
export type InsertAssessmentGradeBoundary = z.infer<typeof insertAssessmentGradeBoundarySchema>;
export type AssessmentGradeBoundary = typeof assessmentGradeBoundaries.$inferSelect;

// Role hierarchy for permission checking
export const roleHierarchy: Record<UserRole, number> = {
  superadmin: 6,
  admin: 5,
  marker: 3,
  tutor: 3,
  iqa: 3,
  student: 1
};
